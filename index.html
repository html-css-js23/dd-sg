<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dovedale Railway | Unofficial Workstation Ledger</title>
    <style>
        :root {
            --bg: #0f1115;
            --panel: #1a1d24;
            --accent: #ffb800; 
            --tol-red: #ff3333;
            --text: #e2e8f0;
            --border: #2d3748;
            --up-color: #4299e1; 
            --down-color: #48bb78; 
            --branch-color: #9f7aea;
        }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        header {
            background: #000;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--accent);
            flex-shrink: 0;
            z-index: 50;
            height: 60px;
            box-sizing: border-box;
        }
        .header-controls { display: flex; gap: 10px; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 2px; text-transform: uppercase; }
        
        .help-btn {
            background: #2d3748;
            color: white;
            border: 2px solid #4a5568;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .help-btn:hover { background: var(--accent); color: black; border-color: var(--accent); }

        .workstation-select {
            background: #2d3748;
            color: white;
            border: 2px solid var(--accent);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
        }
        #add-train-btn, #clear-all-btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 8px 15px;
            font-weight: 800;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s;
        }
        #add-train-btn:hover { transform: scale(1.05); }
        #clear-all-btn { background: #3a1111; color: #ff3333; border: 1px solid #ff3333; }
        #clear-all-btn:hover { background: #ff3333; color: white; }

        .board {
            display: flex;
            gap: 10px;
            padding: 15px;
            overflow-x: auto;
            overflow-y: hidden;
            align-items: flex-start;
            height: calc(100vh - 60px);
            box-sizing: border-box;
        }
        .column {
            background: var(--panel);
            flex: 1 0 220px;
            min-width: 220px;
            max-width: 400px;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 8px;
            max-height: 100%;
            overflow-y: auto;
            box-sizing: border-box;
        }
        .column::-webkit-scrollbar { width: 6px; }
        .column::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        .column.hidden { display: none !important; }
        .column h3 {
            text-align: center;
            font-size: 0.85rem;
            color: #cbd5e0;
            margin: 0 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            background: var(--panel);
            z-index: 5;
        }
        
        .drop-zone {
            background: #121419;
            min-height: 35px;
            margin-bottom: 5px;
            border: 2px dashed #4a5568;
            border-radius: 6px;
            padding: 16px 6px 4px 6px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: 0.2s;
            flex-shrink: 0;
        }
        .drop-zone::before {
            content: attr(data-label);
            position: absolute;
            top: 2px;
            right: 6px;
            font-size: 0.6rem;
            font-weight: bold;
            color: #718096;
            pointer-events: none;
            text-transform: uppercase;
        }
        .block-section { background: #14171c; border-color: #4a5568; flex: 1 0 180px; min-width: 180px; }
        .single-line-zone { border: 2px solid var(--accent); }
        .up-line-zone { border-left: 4px solid var(--up-color); }
        .down-line-zone { border-left: 4px solid var(--down-color); }
        .branch-line-zone { border-left: 4px solid var(--branch-color); }
        .drop-zone.occupied-tol {
            background: rgba(255, 51, 51, 0.15);
            border: 2px solid var(--tol-red);
            box-shadow: inset 0 0 10px rgba(255, 51, 51, 0.2);
        }
        .train {
            background: #fff;
            color: #000;
            padding: 6px;
            border-radius: 4px;
            font-weight: 900;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-left: 5px solid #e2e8f0;
            z-index: 10;
            user-select: none;
            -webkit-user-select: none;
        }
        .train-headcode { font-family: 'Consolas', monospace; font-size: 0.9rem; }
        .train-timer {
            background: #2d3748;
            color: #e2e8f0;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-family: monospace;
            pointer-events: none;
        }
        .train.up-bound { border-left-color: var(--up-color); }
        .train.down-bound { border-left-color: var(--down-color); }
        .train:active { cursor: grabbing; opacity: 0.9; }
        .trash-column { background: #2a1111; border-color: #ff3333; flex: 0 0 160px; min-width: 160px; }
        .trash-column h3 { color: #ff3333; border-color: #ff3333; }
        #trash-zone {
            border-color: #ff3333;
            color: #ff3333;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: bold;
            flex-grow: 1;
            background: rgba(255,0,0,0.1);
        }
        #trash-zone.drag-over { background: rgba(255,0,0,0.4); }
        .modal-overlay {
            position: fixed;
            top:0; left:0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: var(--panel);
            padding: 25px;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-align: center;
            width: 320px;
        }
        .help-content { width: 450px; text-align: left; }
        .help-content h2 { text-align: center; margin-top: 0; color: var(--accent); }
        .help-content ul { padding-left: 20px; line-height: 1.6; }
        .help-content li { margin-bottom: 8px; }
        input, select {
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
            background: #0f1115;
            border: 1px solid #4a5568;
            color: white;
            font-size: 0.95rem;
            margin-bottom: 12px;
            border-radius: 4px;
        }
        .modal-btns { display: flex; gap: 10px; margin-top: 5px; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: var(--accent); color: black; }
        .btn-secondary { background: #4a5568; color: white; }
    </style>
</head>
<body>

    <header>
        <div>
            <h1>Unofficial Dovedale Ledger</h1>
        </div>
        <div class="header-controls">
            <button id="help-btn" class="help-btn">?</button>
            <select id="workstation-selector" class="workstation-select">
                <option value="ALL">Show All Stations</option>
                <option value="MS">Workstation: Masonfield</option>
                <option value="GJ">Workstation: Glassbury Junction</option>
                <option value="CC">Workstation: Codsall Castle</option>
                <option value="MC">Workstation: Marigot Crossing</option>
                <option value="MW">Workstation: Mazewood</option>
                <option value="GE">Workstation: Gleethrop End</option>
                <option value="DC">Workstation: Dovedale Central</option>
                <option value="CH">Workstation: Cosdale Harbour</option>
                <option value="DE">Workstation: Dovedale East</option>
                <option value="SAT">Workstation: Satus Services</option>
                <option value="FM">Workstation: Fanory Mill</option>
                <option value="BL">Workstation: Benyhone Loop</option>
                <option value="AB">Workstation: Ashburn</option>
            </select>
            <button id="clear-all-btn">CLEAR ALL</button>
            <button id="add-train-btn">+ SPAWN TRAIN</button>
        </div>
    </header>

    <div class="board" id="board">
        </div>

    <div id="spawn-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="margin-top:0;">Identify Train</h2>
            <input type="text" id="headcode-input" placeholder="Headcode (e.g. 1A02)" maxlength="4">
            <input type="text" id="class-input" placeholder="Class (e.g. 465)" maxlength="8">
            <select id="cars-input">
                <option value="2C">2 Cars</option>
                <option value="3C">3 Cars</option>
                <option value="4C">4 Cars</option>
                <option value="5C">5 Cars</option>
                <option value="8C">8 Cars</option>
                <option value="FRT">Freight</option>
                <option value="LE">Light Loco</option>
            </select>
            <select id="direction-input">
                <option value="up">Up Train (Towards MS)</option>
                <option value="down">Down Train (Towards AB)</option>
            </select>
            <select id="spawn-loc-input">
                </select>
            <div class="modal-btns">
                <button class="btn btn-secondary" onclick="document.getElementById('spawn-modal').style.display='none'">Cancel</button>
                <button class="btn btn-primary" id="confirm-spawn">SPAWN</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="margin-top:0;">Edit Train</h2>
            <input type="text" id="edit-headcode-input" placeholder="Headcode" maxlength="4">
            <input type="text" id="edit-class-input" placeholder="Class" maxlength="8">
            <select id="edit-cars-input">
                <option value="2C">2 Cars</option>
                <option value="3C">3 Cars</option>
                <option value="4C">4 Cars</option>
                <option value="5C">5 Cars</option>
                <option value="8C">8 Cars</option>
                <option value="FRT">Freight</option>
                <option value="LE">Light Loco</option>
            </select>
            <select id="edit-direction-input">
                <option value="up">Up Train (Towards MS)</option>
                <option value="down">Down Train (Towards AB)</option>
            </select>
            <div class="modal-btns">
                <button class="btn btn-secondary" onclick="document.getElementById('edit-modal').style.display='none'">Cancel</button>
                <button class="btn btn-primary" id="confirm-edit">SAVE</button>
            </div>
        </div>
    </div>

    <div id="help-modal" class="modal-overlay">
        <div class="modal-content help-content">
            <h2>How to Use the Ledger</h2>
            <p><strong>Colors & Lines:</strong></p>
            <ul>
                <li><span style="color:var(--up-color);font-weight:bold;">Blue:</span> UP Trains / UP Lines (Towards Masonfield)</li>
                <li><span style="color:var(--down-color);font-weight:bold;">Green:</span> DOWN Trains / DOWN Lines (Towards Ashburn)</li>
                <li><span style="color:var(--branch-color);font-weight:bold;">Purple:</span> Branch Lines (Gleethrop & Cosdale)</li>
                <li><span style="color:var(--tol-red);font-weight:bold;">Red Pulse:</span> Train On Line (Occupied Track)</li>
            </ul>
            <p><strong>Mechanics:</strong></p>
            <ul>
                <li><strong>Timers:</strong> Each train has a stopwatch. Moving a train to a new block or platform resets its timer.</li>
                <li><strong>Editing:</strong> <strong>Click and Hold</strong> any train card for 2 seconds to edit its headcode, class, cars, and direction.</li>
                <li><strong>Interlocks:</strong> The system enforces Absolute and Tokenless Block rules.</li>
                <li><strong>Removing:</strong> Drag a train to the "END OF LINE" column to permanently despawn it.</li>
                <li><strong>Saving:</strong> The board automatically saves your trains to your browser.</li>
            </ul>
            <button class="btn btn-primary" id="close-help-btn" style="width:100%; margin-top:10px;">Got it!</button>
        </div>
    </div>

    <script>
        let editingTrainId = null;
        let holdTimer = null;

        // --- LAYOUT PARSER ---
        async function loadLayout() {
            try {
                const response = await fetch('layout.txt');
                if (!response.ok) throw new Error("File not found");
                const text = await response.text();
                parseLayoutText(text);
            } catch (err) {
                document.getElementById('board').innerHTML = `<h3 style='color:red; padding: 20px;'>Error loading layout.txt. If you are opening this locally (file://), you must use a local web server (like VS Code Live Server) due to browser security rules.</h3>`;
            }
        }

        function parseLayoutText(text) {
            const board = document.getElementById('board');
            board.innerHTML = '';
            const lines = text.split('\n');
            let currentCol = null;

            lines.forEach(line => {
                line = line.trim();
                if(!line) return;

                let views = "ALL";
                let content = line;
                const viewMatch = line.match(/\[(.*?)\]/);
                if(viewMatch) {
                    views = viewMatch[1];
                    content = line.replace(/\[.*?\]/, '').trim();
                }

                const prefix = content.charAt(0);
                const textContent = content.substring(1).trim();

                if (prefix === '#' || prefix === '>' || prefix === '!') {
                    currentCol = document.createElement('div');
                    currentCol.className = 'column';
                    if(prefix === '>') currentCol.classList.add('block-section');
                    if(prefix === '!') currentCol.classList.add('trash-column');
                    currentCol.setAttribute('data-views', views);

                    const h3 = document.createElement('h3');
                    h3.innerText = textContent;
                    currentCol.appendChild(h3);

                    if(prefix === '!') {
                        const dz = document.createElement('div');
                        dz.className = 'drop-zone';
                        dz.id = 'trash-zone';
                        dz.setAttribute('data-type', 'trash');
                        dz.innerHTML = '<br>DROP TRAIN HERE';
                        attachDropListeners(dz);
                        currentCol.appendChild(dz);
                    }
                    board.appendChild(currentCol);
                } else if (currentCol && prefix !== '!') {
                    const parts = textContent.split('|').map(s => s.trim());
                    const label = parts[0];
                    const typeInfo = parts[1] || '';

                    const dz = document.createElement('div');
                    dz.className = 'drop-zone';
                    
                    const colName = currentCol.querySelector('h3').innerText;
                    dz.id = (colName + '-' + label).replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
                    dz.setAttribute('data-label', label);

                    if (prefix === '=') {
                        dz.setAttribute('data-type', 'absolute');
                        if(typeInfo === 'up') dz.classList.add('up-line-zone');
                        if(typeInfo === 'down') dz.classList.add('down-line-zone');
                        if(typeInfo === 'branch') dz.classList.add('branch-line-zone');
                    } else if (prefix === '*') {
                        dz.setAttribute('data-type', 'single');
                        dz.classList.add('single-line-zone');
                        if(typeInfo === 'branch') dz.classList.add('branch-line-zone');
                    } else if (prefix === '^') {
                        dz.classList.add('up-line-zone');
                    } else if (prefix === 'v') {
                        dz.classList.add('down-line-zone');
                    }

                    attachDropListeners(dz);
                    currentCol.appendChild(dz);
                }
            });

            populateSpawnDropdown();
            loadState();
        }

        function populateSpawnDropdown() {
            const select = document.getElementById('spawn-loc-input');
            select.innerHTML = '';
            document.querySelectorAll('.column:not(.block-section):not(.trash-column) .drop-zone').forEach(dz => {
                const opt = document.createElement('option');
                opt.value = dz.id;
                const stationName = dz.closest('.column').querySelector('h3').innerText;
                opt.innerText = `${stationName} - ${dz.getAttribute('data-label')}`;
                select.appendChild(opt);
            });
        }

        // --- UI & LOGIC ---
        const workstationSelect = document.getElementById('workstation-selector');
        workstationSelect.addEventListener('change', (e) => {
            const selectedView = e.target.value;
            document.querySelectorAll('.column').forEach(col => {
                const views = col.getAttribute('data-views').split(' ');
                if (views.includes(selectedView)) col.classList.remove('hidden');
                else col.classList.add('hidden');
            });
        });

        const spawnModal = document.getElementById('spawn-modal');
        const editModal = document.getElementById('edit-modal');
        const helpModal = document.getElementById('help-modal');

        document.getElementById('help-btn').onclick = () => helpModal.style.display = 'flex';
        document.getElementById('close-help-btn').onclick = () => helpModal.style.display = 'none';
        document.getElementById('add-train-btn').onclick = () => { spawnModal.style.display = 'flex'; document.getElementById('headcode-input').focus(); };

        document.getElementById('clear-all-btn').onclick = () => {
            if(confirm("Are you sure you want to delete ALL trains from the ledger?")) {
                document.querySelectorAll('.train').forEach(t => t.remove());
                updateTOL();
                saveState();
            }
        };

        document.getElementById('confirm-spawn').onclick = () => {
            const headcode = document.getElementById('headcode-input').value.toUpperCase() || "UNKN";
            const tClass = document.getElementById('class-input').value.toUpperCase() || "---";
            const tCars = document.getElementById('cars-input').value;
            const dir = document.getElementById('direction-input').value;
            const loc = document.getElementById('spawn-loc-input').value;
            
            createTrain(headcode, tClass, tCars, dir, loc);
            spawnModal.style.display = 'none';
            document.getElementById('headcode-input').value = "";
            document.getElementById('class-input').value = "";
        };

        document.getElementById('confirm-edit').onclick = () => {
            if(!editingTrainId) return;
            const train = document.getElementById(editingTrainId);
            if(train) {
                const newHeadcode = document.getElementById('edit-headcode-input').value.toUpperCase();
                const newClass = document.getElementById('edit-class-input').value.toUpperCase();
                const newCars = document.getElementById('edit-cars-input').value;
                const newDir = document.getElementById('edit-direction-input').value;
                
                train.setAttribute('data-headcode', newHeadcode);
                train.setAttribute('data-class', newClass);
                train.setAttribute('data-cars', newCars);
                train.setAttribute('data-direction', newDir);
                
                train.className = `train ${newDir === 'up' ? 'up-bound' : 'down-bound'}`;
                const arrow = newDir === 'up' ? '⬅' : '➔';
                train.querySelector('.train-headcode').innerText = `${arrow} ${newHeadcode} | ${newClass} | ${newCars}`;
                saveState();
            }
            editModal.style.display = 'none';
        };

        function saveState() {
            const state = [];
            document.querySelectorAll('.drop-zone').forEach(zone => {
                const trains = [];
                zone.querySelectorAll('.train').forEach(t => {
                    trains.push({
                        id: t.id,
                        headcode: t.getAttribute('data-headcode'),
                        tClass: t.getAttribute('data-class'),
                        tCars: t.getAttribute('data-cars'),
                        direction: t.getAttribute('data-direction'),
                        timestamp: t.getAttribute('data-timestamp')
                    });
                });
                if(trains.length > 0) state.push({ zoneId: zone.id, trains: trains });
            });
            localStorage.setItem('dovedaleState', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('dovedaleState');
            if(!saved) return;
            const state = JSON.parse(saved);
            state.forEach(zoneData => {
                const zone = document.getElementById(zoneData.zoneId);
                if(zone && zoneData.zoneId !== 'trash-zone') {
                    zoneData.trains.forEach(tData => {
                        createTrain(tData.headcode, tData.tClass, tData.tCars, tData.direction, zone.id, tData.id, tData.timestamp);
                    });
                }
            });
            updateTOL();
        }

        function createTrain(headcode, tClass, tCars, direction, locationId, existingId = null, existingTs = null) {
            const train = document.createElement('div');
            train.className = `train ${direction === 'up' ? 'up-bound' : 'down-bound'}`;
            train.id = existingId || ('train-' + Math.random().toString(36).substr(2, 9));
            train.draggable = true;
            
            train.setAttribute('data-headcode', headcode);
            train.setAttribute('data-class', tClass || "---");
            train.setAttribute('data-cars', tCars || "2C");
            train.setAttribute('data-direction', direction);
            train.setAttribute('data-timestamp', existingTs || Date.now());

            const arrow = direction === 'up' ? '⬅' : '➔';
            const headcodeSpan = document.createElement('span');
            headcodeSpan.className = 'train-headcode';
            headcodeSpan.innerText = `${arrow} ${headcode} | ${tClass} | ${tCars}`;
            
            const timerSpan = document.createElement('span');
            timerSpan.className = 'train-timer';
            timerSpan.innerText = '00:00';

            train.appendChild(headcodeSpan);
            train.appendChild(timerSpan);

            train.addEventListener('dragstart', (e) => {
                clearTimeout(holdTimer);
                e.dataTransfer.setData('text/plain', train.id);
                setTimeout(() => train.style.opacity = '0.5', 0); 
            });
            train.addEventListener('dragend', () => train.style.opacity = '1');
            
            const startHold = () => { holdTimer = setTimeout(() => openEditModal(train), 1500); };
            const clearHold = () => { clearTimeout(holdTimer); };

            train.addEventListener('mousedown', startHold);
            train.addEventListener('mouseup', clearHold);
            train.addEventListener('mouseleave', clearHold);
            train.addEventListener('touchstart', startHold);
            train.addEventListener('touchend', clearHold);
            train.addEventListener('touchmove', clearHold);

            const targetZone = document.getElementById(locationId);
            if(targetZone) targetZone.appendChild(train);
            
            if(!existingId) saveState();
        }

        function openEditModal(train) {
            editingTrainId = train.id;
            document.getElementById('edit-headcode-input').value = train.getAttribute('data-headcode');
            document.getElementById('edit-class-input').value = train.getAttribute('data-class');
            document.getElementById('edit-cars-input').value = train.getAttribute('data-cars');
            document.getElementById('edit-direction-input').value = train.getAttribute('data-direction');
            editModal.style.display = 'flex';
        }

        function attachDropListeners(zone) {
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                if(zone.id === 'trash-zone') zone.classList.add('drag-over');
                else zone.style.background = '#2d3748'; 
            });

            zone.addEventListener('dragleave', () => {
                zone.style.background = ''; 
                zone.classList.remove('drag-over');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.style.background = '';
                zone.classList.remove('drag-over');
                
                const trainId = e.dataTransfer.getData('text/plain');
                const train = document.getElementById(trainId);
                if (!train) return;
                
                if (zone.id === 'trash-zone') {
                    train.remove();
                    updateTOL();
                    saveState();
                    return;
                }

                const lineType = zone.getAttribute('data-type');
                if (lineType === 'single' && zone.children.length >= 1) {
                    alert("SAFETY INTERLOCK: Tokenless Block section is OCCUPIED. Stop!");
                    return; 
                }
                if (lineType === 'absolute' && zone.children.length >= 1) {
                    alert("SAFETY INTERLOCK: Absolute Block section occupied. Stop!");
                    return; 
                }

                train.setAttribute('data-timestamp', Date.now());
                zone.appendChild(train);
                updateTOL();
                saveState();
            });
        }

        function updateTOL() {
            document.querySelectorAll('.drop-zone[data-type="absolute"], .drop-zone[data-type="single"]').forEach(zone => {
                if (zone.children.length > 0) zone.classList.add('occupied-tol');
                else zone.classList.remove('occupied-tol');
            });
        }

        setInterval(() => {
            const now = Date.now();
            document.querySelectorAll('.train').forEach(train => {
                const ts = parseInt(train.getAttribute('data-timestamp')) || now;
                const diff = Math.floor((now - ts) / 1000);
                const m = String(Math.floor(diff / 60)).padStart(2, '0');
                const s = String(diff % 60).padStart(2, '0');
                const timerEl = train.querySelector('.train-timer');
                if (timerEl) timerEl.innerText = `${m}:${s}`;
            });
        }, 1000);

        window.onload = loadLayout;
    </script>
</body>
</html>
